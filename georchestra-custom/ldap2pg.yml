#
#
#       L D A P 2 P G   S A M P L E   C O N F I G U R A T I O N
#
#
# This is a starting point configuration file for ldap2pg.yml. Including static
# roles, groups, privilege and LDAP query.
#
# This configuration assumes the following principles:
#
# - All LDAP users are grouped in `ldap_roles` group.
# - Read privileges are granted to `readers` group.
# - Write privileges are granted to `writers` group.
# - DDL privileges are granted to `owners` group.
# - We have one or more databases with public and maybe a schema.
# - Grants are not specific to a schema. Once you're writer in a database, you
#   are writer to all schemas in it.
#
# The LDAP directory content is described in fixtures/openldap-data.ldif
#
# Adapt to your needs! See also full documentation on how to configure ldap2pg
# at https://ldap2pg.readthedocs.io/en/latest/config/.
#
# Don't hesitate to suggest improvements for this starting configuration at
# https://github.com/dalibo/ldap2pg/issues/new . Thanks for your contribution !
#

#
# File format version. Allows ldap2pg to check whether the file is supported.
#
#version: 5
# Colorization. env var: COLOR=<anything>
color: yes
#
# # Verbose messages. Includes SQL and LDAP queries. env var: VERBOSITY
# verbosity: 5
#
# # Dry mode. env var: DRY=<anything>
# dry: yes

#
#       0.   LDAP   CONFIG
#
# Use env vars instead: see https://ldap2pg.readthedocs.io/en/latest/cli/#environment-variables
# ldap:
#   uri: ldap://192.168.1.70:3389
#   binddn: cn=admin,dc=georchestra,dc=org
#   password: secret

#
#       1.   P O S T G R E S   I N S P E C T I O N
#
#  See https://ldap2pg.readthedocs.io/en/latest/postgres/
#

postgres:
  # Use env vars instead: see https://ldap2pg.readthedocs.io/en/latest/cli/#environment-variables
  #dsn: "host=192.168.1.70 port=5432 user=georchestra dbname=georchestra"
  # dsn: postgres://georchestra:geo@192.168.1.70:5434/georchestra
  databases_query: |
    SELECT datname
    FROM pg_catalog.pg_database
    WHERE datallowconn IS TRUE
    AND datname NOT IN ('postgres','template1', 'template_postgis');

  # List of role names which can be dropped from cluster. Privileges on these
  # roles can be revoked.
  managed_roles_query: |
    SELECT 'public'
    UNION
    SELECT DISTINCT role.rolname
    FROM pg_roles AS role
    LEFT OUTER JOIN pg_auth_members AS ms ON ms.member = role.oid
    LEFT OUTER JOIN pg_roles AS ldap_roles
      ON ldap_roles.rolname = 'ldap_roles' AND ldap_roles.oid = ms.roleid
    WHERE role.rolname IN ('ldap_roles', 'readers', 'writers', 'owners')
        OR ldap_roles.oid IS NOT NULL
    ORDER BY 1;

  # List of object owners that requires default privileges configuration. Since
  # readers/writer/owners groups are globals to cluster, we have a global
  # owners_query.
  owners_query: |
    SELECT DISTINCT role.rolname
    FROM pg_catalog.pg_roles AS role
    JOIN pg_catalog.pg_auth_members AS ms ON ms.member = role.oid
    JOIN pg_catalog.pg_roles AS owners
      ON owners.rolname = 'owners' AND owners.oid = ms.roleid
    ORDER BY 1;

  # Exclude information_schema, pg_catalog, pg_toast, and other system schemas
  # from privilege management.
  schemas_query: |
    SELECT
      nspname,
      array_agg(owner.rolname) FILTER (WHERE owner.rolname IS NOT NULL)
    FROM pg_catalog.pg_namespace
    LEFT OUTER JOIN pg_catalog.pg_roles AS owners_group
      ON owners_group.rolname = 'owners_' || nspname
    LEFT OUTER JOIN pg_catalog.pg_auth_members AS ms ON ms.roleid = owners_group.oid
    LEFT OUTER JOIN pg_catalog.pg_roles AS owner ON owner.oid = ms.member
    WHERE nspname NOT LIKE 'pg_%' AND nspname <> 'information_schema'
    AND nspname NOT LIKE 'tiger%' AND nspname <> 'topology'
    GROUP BY 1


#
#       2.   P R I V I L E G E S   D E F I N I T I O N
#
# See https://ldap2pg.readthedocs.io/en/latest/privileges/. Privileges wrapped
# in double underscores are well-known privileges built-in ldap2pg. See
# https://ldap2pg.readthedocs.io/en/latest/wellknown/ for a documentation of
# each of them.
#

privileges:
  # Define `ro` privilege group with read-only grants
  ro:
  - __connect__
  - __select_on_tables__
  - __select_on_sequences__
  - __usage_on_schemas__
  - __usage_on_types__

  # `rw` privilege group lists write-only grants
  rw:
  - __temporary__
  - __all_on_tables__
  - __all_on_sequences__

  # `ddl` privilege group lists DDL only grants.
  ddl:
  - __create_on_schemas__


#
#       3.   S Y N C H R O N I S A T I O N   M A P
#
# This list contains rules to declare roles and grants. Each role or grant rule
# can be templated with attributes from LDAP entries returned by a search
# query.
#
# Any role found in cluster and not generated by sync_map will be dropped. Any
# grant found in cluster and not generated by sync_map will be revoked.
#

sync_map:
- description: "Setup static roles and grants."
  roles:
  - names:
    - ldap_roles
    - readers
    options: NOLOGIN
  - name: publishers
    # Grant reading to writers
    parent: readers
    options: NOLOGIN
  - name: writers
    # Grant read/write to owners
    parent: publishers
    options: NOLOGIN

  grant:
  - privilege: ro
    role: readers
    schemas: __all__
  - privilege: rw
    role: publishers
    schema: __all__
  - privilege: ddl
    role: writers
    schema: __all__


- description: "Query LDAP to create schemas _readers, _publishers and _writers."
  ldap:
    base: ou=roles,dc=georchestra,dc=org
    filter: "(cn=PGSQL_SCHEMA_*)"
  roles:
  - name: '{cn.regex()}_readers'
    parent: ldap_roles
    options: NOLOGIN
  - name: '{cn.regex()}_publishers'
    parents:
    - ldap_roles
    - '{cn.regex()}_readers'
    options: NOLOGIN
  - name: '{cn.regex()}_writers'
    parents:
    - ldap_roles
    - '{cn.regex()}_publishers'
    options: NOLOGIN
  grant:
  - privilege: ro
    role: '{cn.regex()}_readers'
    schema: "{cn.regex()}"
  - privilege: rw
    role: '{cn.regex()}_publishers'
    schema: "{cn.regex()}"
  - privilege: ddl
    role: '{cn.regex()}_writers'
    schema: "{cn.regex()}"

- description: "Query LDAP for [schema]_readers profiles."
  ldap:
    base: ou=roles,dc=georchestra,dc=org
    filter: "(&(objectClass=groupOfMembers)(cn=PGSQL_SCHEMA_*_READER))"
    join:
      member:
        filter: "(&(objectClass=georchestraUser)(uid=*))"
  roles:
  - name: '{cn.regex()}_readers'
    parent: ldap_roles
    options: NOLOGIN
    member: '{member.uid}'
  - name: '{member.uid}'
    parent: ldap_roles
    options: LOGIN

- description: "Query LDAP for [schema]_publishers profiles."
  ldap:
    base: ou=roles,dc=georchestra,dc=org
    filter: "(&(objectClass=groupOfMembers)(cn=PGSQL_SCHEMA_*_PUBLISHER))"
    join:
      member:
        filter: "(&(objectClass=georchestraUser)(uid=*))"
  roles:
  - name: '{cn.regex()}_publishers'
    parents:
    - ldap_roles
    - '{cn.regex()}_readers'
    options: NOLOGIN
    member: '{member.uid}'
  - name: '{member.uid}'
    parent: ldap_roles
    options: LOGIN

- description: "Query LDAP for [schema]_writers profiles."
  ldap:
    base: ou=roles,dc=georchestra,dc=org
    filter: "(&(objectClass=groupOfMembers)(cn=PGSQL_SCHEMA_*_WRITER))"
    join:
      member:
        filter: "(&(objectClass=georchestraUser)(uid=*))"
  roles:
  - name: '{cn.regex()}_writers'
    parents:
    - ldap_roles
    - '{cn.regex()}_publishers'
    options: NOLOGIN
    member: '{member.uid}'
  - name: '{member.uid}'
    parent: ldap_roles
    options: LOGIN
